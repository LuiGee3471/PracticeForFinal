<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Home</title>
    <script
      src="https://code.jquery.com/jquery-3.4.1.min.js"
      integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo="
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.3.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
  </head>
  <body>
    <div th:unless="${user}">
      <a href="#" th:href="@{/reg}">회원가입</a>
      <a href="#" th:href="@{/login}">로그인</a>
    </div>
    <div th:if="${user}">
      <p><span th:text="${user.id}" id="userid"></span>&nbsp;환영합니다.</p>
    </div>
    <div id="noti"></div>
    <table>
      <tr>
        <th>제목</th>
        <th>내용</th>
        <th>글쓴이</th>
      </tr>
      <tr th:each="board : ${boardList}">
        <td th:text="${board.title}"></td>
        <td>
          <a href="#" th:href="@{'/board/' + ${board.id}}"
            ><span th:text="${board.content}"></span
          ></a>
        </td>
        <td th:text="${board.writer}"></td>
      </tr>
    </table>

    <script>
      var user = document.getElementById("userid");
      if (user) {
        var sock = new SockJS("/sample");
        var client = Stomp.over(sock);

        client.connect({}, function() {
          client.subscribe("/topic/noti/" + user.innerText, function(data) {
            var message = JSON.parse(data.body);
            var noti = document.getElementById("noti");
            var newNotice = document.createElement("div");
            var h5 = document.createElement("h5");
            h5.innerText = "댓글이 달렸습니다."
            var p = document.createElement("p");
            p.innerText = message.writer + "님 " + message.content;
            newNotice.appendChild(h5);
            newNotice.appendChild(p);
            noti.appendChild(newNotice);

            setTimeout(function() {
              noti.removeChild(newNotice);
            }, 5000);
          });
        });
      }
    </script>
  </body>
</html>
